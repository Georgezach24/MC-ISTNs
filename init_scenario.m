function S = init_scenario(P)
% Συνάρτηση αρχικοποίησης της κατάστασης (state) της προσομοίωσης και
% προδέσμευσης δομών/μνήμης για URLLC και logs.

% --------- UE - User Equipment ---------------------------------------
S.t = 0;            % Αρχικοποίηση χρόνου προσομοίωσης (σε slots ή/και seconds ανάλογα τη χρήση).
S.UE.x = P.UE.x0;   % Αρχική θέση χρήστη (λαμβάνεται από τις παραμέτρους P).
S.UE.v = P.UE.v;    % Ταχύτητα χρήστη (λαμβάνεται από τις παραμέτρους P).
%----------------------------------------------------------------------

% --------- Serving Nodes (τρέχον serving) ----------------------------
S.servBS  = 1;      % Δείκτης (index) του επίγειου BS που σερβίρει αρχικά τον UE.
S.servSAT = 1;      % Δείκτης (index) του δορυφόρου που σερβίρει αρχικά τον UE.
%----------------------------------------------------------------------

% --------- Current Action (πολιτική/ενέργεια συστήματος) -------------
S.action.modeU = 0; % URLLC mode: 0 TN, 1 NTN, 2 SPLIT, 3 DUP
S.action.modeE = 0; % eMBB  mode: 0 TN, 1 NTN, 2 SPLIT
% Τα mode εδώ αντιστοιχούν στην απόφαση serving ανά υπηρεσία:
% - TN: εξυπηρέτηση μόνο από επίγειο
% - NTN: εξυπηρέτηση μόνο από δορυφόρο
% - SPLIT: καταμερισμός/συνάθροιση πόρων σε δύο links
% - DUP: διπλή μετάδοση (κυρίως για URLLC αξιοπιστία)
%----------------------------------------------------------------------

% =====================================================================
%                     HANDOVER STATE (TN)
% =====================================================================
S.HO_TN.active   = false;                 % Flag: αν βρίσκεται σε εξέλιξη TN handover (interruption).
S.HO_TN.timer_s  = 0;                     % Μετρητής χρόνου εκτέλεσης HO (σε seconds).
S.HO_TN.ttt_s    = 0;                     % Μετρητής Time-To-Trigger που έχει “συσσωρευτεί”.
S.HO_TN.cand     = S.servBS;              % Candidate BS για HO (αρχικά ο τρέχων serving).
S.HO_TN.filtSINR = ones(1, numel(P.BS));  % Φιλτραρισμένο SINR (ή μετρική) ανά BS.
%----------------------------------------------------------------------

% =====================================================================
%                     HANDOVER STATE (NTN)
% =====================================================================
S.HO_NTN.active   = false;                  % Flag: αν βρίσκεται σε εξέλιξη NTN handover.
S.HO_NTN.timer_s  = 0;                      % Μετρητής χρόνου εκτέλεσης NTN HO (σε seconds).
S.HO_NTN.ttt_s    = 0;                      % Μετρητής Time-To-Trigger για NTN HO.
S.HO_NTN.cand     = S.servSAT;              % Candidate Satellite για HO (αρχικά ο τρέχων serving).
S.HO_NTN.filtSINR = ones(1, numel(P.SAT));  % Φιλτραρισμένο SINR ανά SAT.
%----------------------------------------------------------------------

% =====================================================================
%               URLLC PACKET STORE (preallocated FIFO)
% =====================================================================
S.URLLC.genCount  = 0;  % Πλήθος πακέτων που δημιουργήθηκαν συνολικά.
S.URLLC.succCount = 0;  % Πλήθος πακέτων που παραδόθηκαν επιτυχώς εντός deadline.
S.URLLC.failCount = 0;  % Πλήθος πακέτων που απέτυχαν (π.χ. λόγω deadline expiry).
% Οι counters χρησιμοποιούνται για KPI (π.χ. reliability, drop rate).
%----------------------------------------------------------------------

S.URLLC.head = 1; % Δείκτης head-of-line πακέτου (το παλαιότερο ενεργό στο FIFO).
S.URLLC.tail = 0; % Πλήθος πακέτων που έχουν παραχθεί (άρα tail = “τελευταίο index”).
%----------------------------------------------------------------------

% --------- Εκτίμηση μέγιστων πακέτων για preallocation ---------------
% URLLC:
genRate = 100;          % pkt/s (σταθερή εκτίμηση ρυθμού άφιξης για sizing).
simTime = P.T * P.dt;   % Συνολικός χρόνος προσομοίωσης σε seconds.
%----------------------------------------------------------------------

S.URLLC.maxPkts = ceil(simTime * genRate) + 2000; % +margin ασφαλείας
%----------------------------------------------------------------------

% --------- Ορισμός δομής πακέτου και preallocation ουράς -------------
S.URLLC.queue(S.URLLC.maxPkts,1) = struct( ...
    'genTime',   0, ...     % Χρόνος γέννησης του πακέτου (seconds ή slot-time reference).
    'delivered', false, ... % Flag: αν παραδόθηκε επιτυχώς.
    'expired',   false, ... % Flag: αν έληξε (deadline missed).
    'delay',     NaN);      % Καθυστέρηση παράδοσης (seconds). NaN αν δεν παραδόθηκε.
%----------------------------------------------------------------------

% --------- Μεταβλητές που θα ενημερώνονται κάθε iteration -------------
S.URLLC.pktBits     = 64*8; % Μέγεθος URLLC πακέτου σε bits (ευθυγραμμισμένο με P.URLLC.pktSize).
S.URLLC.nextGenTime = 0;    % Επόμενος χρόνος γέννησης πακέτου (θα το θέτει traffic_step).
%----------------------------------------------------------------------

% =====================================================================
%                             LOGS
% =====================================================================
S.log = struct(); % Αρχικοποίηση δομής logs για αποθήκευση ιστορικού.
%----------------------------------------------------------------------

% --------- Προδέσμευση βασικών logs για επιτάχυνση --------------------
S.log.actionU = zeros(P.T,1,'uint8'); % Log του URLLC action ανά slot (μικρό type για οικονομία).
S.log.actionE = zeros(P.T,1,'uint8'); % Log του eMBB action ανά slot.
%----------------------------------------------------------------------

S.log.SINR_TN_DL  = zeros(P.T,1); % Log SINR Downlink για TN ανά slot.
S.log.SINR_NTN_DL = zeros(P.T,1); % Log SINR Downlink για NTN ανά slot.
%----------------------------------------------------------------------

S.log.hoTN  = zeros(P.T,1); % Log/flag γεγονότων TN handover ανά slot (π.χ. 0/1 ή states).
S.log.hoNTN = zeros(P.T,1); % Log/flag γεγονότων NTN handover ανά slot.
%----------------------------------------------------------------------

S.log.servBS  = zeros(P.T,1,'uint8'); % Log serving BS index ανά slot.
S.log.servSAT = zeros(P.T,1,'uint8'); % Log serving SAT index ανά slot.
S.log.ueX     = zeros(P.T,1);         % Log θέσης UE ανά slot.
%----------------------------------------------------------------------

S.log.kpi_URLLC_succ  = zeros(P.T,1); % Log επιτυχίας URLLC (π.χ. delivered within deadline) ανά slot.
S.log.kpi_URLLC_delay = nan(P.T,1);   % Log delay URLLC ανά slot (NaN όταν δεν υπάρχει delivered pkt).
%----------------------------------------------------------------------

end