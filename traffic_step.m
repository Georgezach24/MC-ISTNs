function S = traffic_step(S, P, k)
% Συνάρτηση παραγωγής URLLC πακέτων και εισαγωγής τους σε FIFO ουρά.
% Μοντέλο traffic:
% - Δημιουργεί 1 πακέτο κάθε 10 ms  => 100 packets/sec
% - Χρησιμοποιεί preallocated queue για αποδοτικότητα
% - Ενημερώνει counters και δείκτες 

% --------- Χρονική στιγμή slot ---------------------------------------
t = (k-1) * P.dt;   % Τρέχων χρόνος προσομοίωσης σε seconds.
%----------------------------------------------------------------------

% --------- Παράμετροι traffic ----------------------------------------
period  = 10e-3;    % Περίοδος άφιξης πακέτου (10 ms).
pktBits = 64*8;     % Μέγεθος URLLC πακέτου σε bits (512 bits).
%----------------------------------------------------------------------

% --------- Αποθήκευση μεγέθους πακέτου στο state ----------------------
% (ώστε να το χρησιμοποιεί η serve συνάρτηση χωρίς να εξαρτάται από P)
S.URLLC.pktBits = pktBits;
%----------------------------------------------------------------------

% =====================================================================
%                     Δημιουργία νέου πακέτου 
% =====================================================================

% Αν ο τρέχων χρόνος ξεπεράσει τον επόμενο προγραμματισμένο χρόνο γέννησης,
% δημιουργούμε 1 νέο πακέτο και το βάζουμε στο τέλος της FIFO.
if t >= S.URLLC.nextGenTime

    % --------- Counter συνολικών πακέτων ------------------------------
    S.URLLC.genCount = S.URLLC.genCount + 1; % Πλήθος πακέτων που δημιουργήθηκαν συνολικά.
    %----------------------------------------------------------------------

    % --------- Εισαγωγή στο FIFO (tail++) ------------------------------
    S.URLLC.tail = S.URLLC.tail + 1; % Νέο πακέτο στο τέλος της ουράς.
    j = S.URLLC.tail;                % Index νέου πακέτου.
    %----------------------------------------------------------------------

    % --------- Safety check: overflow preallocation --------------------
    % Αν ξεπεράσουμε το maxPkts, σημαίνει ότι το preallocation sizing ήταν μικρό.
    if j > S.URLLC.maxPkts
        error('URLLC.maxPkts exceeded. Increase margin in init_scenario.');
    end
    %----------------------------------------------------------------------

    % --------- Αρχικοποίηση εγγραφής πακέτου ---------------------------
    S.URLLC.queue(j).genTime   = t;     % Χρόνος γέννησης.
    S.URLLC.queue(j).delivered = false; % Δεν έχει παραδοθεί ακόμα.
    S.URLLC.queue(j).expired   = false; % Δεν έχει λήξει ακόμα.
    S.URLLC.queue(j).delay     = NaN;   % Άγνωστη καθυστέρηση μέχρι να παραδοθεί.
    %----------------------------------------------------------------------

    % --------- Προγραμματισμός επόμενης γέννησης -----------------------
    S.URLLC.nextGenTime = S.URLLC.nextGenTime + period;
    %----------------------------------------------------------------------

end

end